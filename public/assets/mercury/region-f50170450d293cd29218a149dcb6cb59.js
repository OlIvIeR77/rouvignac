(function(){this.Mercury.Region=function(){function t(t,e,n){this.element=t,this.window=e,this.options=null!=n?n:{},Mercury.log("building "+this.type(),this.element,this.options),this.document=this.window.document,this.name=this.element.attr(Mercury.config.regions.identifier),this.history=new Mercury.HistoryBuffer,this.build(),this.bindEvents(),this.pushHistory(),this.element.data("region",this)}return t.prototype.type=function(){return"unknown"},t.prototype.build=function(){},t.prototype.focus=function(){},t.prototype.bindEvents=function(){return Mercury.on("mode",function(t){return function(e,n){return"preview"===n.mode?t.togglePreview():void 0}}(this)),Mercury.on("focus:frame",function(t){return function(){return t.previewing||Mercury.region!==t?void 0:t.focus()}}(this)),Mercury.on("action",function(t){return function(e,n){return t.previewing||Mercury.region!==t||e.isDefaultPrevented()?void 0:n.action?t.execCommand(n.action,n):void 0}}(this)),this.element.on("mousemove",function(t){return function(e){var n;if(!t.previewing&&Mercury.region===t)return n=jQuery(e.target).closest("[data-snippet]"),n.length&&(t.snippet=n,t.snippet.data("snippet"))?Mercury.trigger("show:toolbar",{type:"snippet",snippet:t.snippet}):void 0}}(this)),this.element.on("mouseout",function(t){return function(){return t.previewing?void 0:Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!1})}}(this))},t.prototype.content=function(t,e){var n,i,r,o,u;if(null==t&&(t=null),null==e&&(e=!1),null!==t)return this.element.html(t);if(n=document.createElement("div"),n.innerHTML=this.element.html().replace(/^\s+|\s+$/g,""),n=$(n),e)for(u=n.find("[data-snippet]"),r=0,o=u.length;o>r;r++)i=u[r],i=jQuery(i),i.attr({contenteditable:null,"data-version":null}),i.html("["+i.data("snippet")+"]");return n.html()},t.prototype.togglePreview=function(){return this.previewing?(this.previewing=!1,this.element.attr(Mercury.config.regions.attribute,this.type()),Mercury.region===this?this.focus():void 0):(this.previewing=!0,this.element.removeAttr(Mercury.config.regions.attribute),Mercury.trigger("region:blurred",{region:this}))},t.prototype.execCommand=function(t,e){return null==e&&(e={}),this.focus(),"redo"!==t&&this.pushHistory(),Mercury.log("execCommand",t,e.value),Mercury.changes=!0},t.prototype.pushHistory=function(){return this.history.push(this.content())},t.prototype.snippets=function(){var t,e,n,i,r,o;for(n={},o=this.element.find("[data-snippet]"),i=0,r=o.length;r>i;i++)t=o[i],e=Mercury.Snippet.find(jQuery(t).data("snippet")),e&&(n[e.identity]=e.serialize());return n},t.prototype.dataAttributes=function(){var t,e,n,i,r;for(e={},r=Mercury.config.regions.dataAttributes,n=0,i=r.length;i>n;n++)t=r[n],e[t]=(this.container||this.element).attr("data-"+t);return e},t.prototype.serialize=function(){return{type:this.type(),data:this.dataAttributes(),value:this.content(null,!0),snippets:this.snippets()}},t}()}).call(this);